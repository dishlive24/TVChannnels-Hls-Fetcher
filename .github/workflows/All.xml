name: Update All Playlists

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */12 * * *'

jobs:
  update-playlists:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Fetch and prepare all .m3u files
      env:
        SONYLIV_URL: ${{ secrets.SONYLIV_URL }}
        SUNNXT_URL: ${{ secrets.SUNNXT_URL }}
        DISTROTV_URL: ${{ secrets.DISTROTV_URL }}
      run: |
        fetch_and_prepare() {
          NAME=$1
          URL=$2

          echo "Fetching $NAME.m3u from $URL"
          curl -s -o original.m3u "$URL"
          
          echo '# This m3u presented by https://t.me/FreeDishBhai' > "$NAME.m3u"
          echo '# API from dishlive24 (FreeDishBhai)' >> "$NAME.m3u"
          cat original.m3u >> "$NAME.m3u"
          rm original.m3u
        }

        fetch_and_prepare "SonyLIV" "$SONYLIV_URL"
        fetch_and_prepare "Sun-NXT" "$SUNNXT_URL"
        fetch_and_prepare "DistroTV" "$DISTROTV_URL"

    - name: Commit and push changes
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

        git add *.m3u
        git commit -m "Update all .m3u playlists." || echo "No changes to commit"

        git pull origin main --rebase
        git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}
        git push origin HEAD:main
